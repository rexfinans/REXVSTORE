<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipari≈üi Tamamla - RexvStore</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .checkout-container { max-width: 1024px; } 
        /* Girdi ve Buton odaklanma efekti */
        input:focus, textarea:focus, select:focus {
            border-color: #dc2626 !important;
            box-shadow: 0 0 0 1px rgba(220, 38, 38, 0.5) !important;
            outline: none;
        }
        /* A√ßƒ±lƒ±r men√º stilini Tailwind ile g√º√ßlendir */
        #payment-method-select {
            appearance: none; 
            background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22none%22%3E%3Cpath%20d%3D%22M7%207l3%203%203-3m0%206l-3%203-3-3%22%20stroke%3D%22%23DC2626%22%20stroke-width%3D%221.5%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; 
        }

        /* Destek Butonu Stili (Telegram rengi) */
        #support-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            cursor: pointer;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            background-color: #0088CC; /* Telegram Mavi */
        }
        #support-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0, 136, 204, 0.5); /* Telegram Mavi g√∂lge */
        }
    </style>
</head>
<body class="p-4 sm:p-6 pb-20"> <div class="checkout-container mx-auto">
    <div class="flex items-center mb-6">
        <a href="index.html" class="text-red-600 hover:text-red-700 transition mr-4">
            <i class="fas fa-chevron-left text-xl"></i>
        </a>
        <h1 class="text-3xl font-bold text-gray-800">Sipari≈üi Tamamla</h1>
    </div>

    <div id="loading-spinner" class="text-center py-10" style="display: none;">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-red-500 border-t-transparent mx-auto mb-3"></div>
        <p class="text-gray-600 font-medium">Veriler y√ºkleniyor...</p>
    </div>

    <div id="empty-cart" class="bg-white p-8 rounded-xl shadow-lg text-center" style="display: none;">
        <i class="fas fa-shopping-basket text-6xl text-gray-300 mb-4"></i>
        <h2 class="text-xl font-semibold mb-2">Sepetiniz Bo≈ü G√∂r√ºn√ºyor!</h2>
        <a href="index.html" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
            √úr√ºnlere Geri D√∂n
        </a>
    </div>

    <div id="checkout-content" class="lg:grid lg:grid-cols-3 lg:gap-8" style="display: none;">
        
        <div class="lg:col-span-3 mb-6">
            <div class="bg-white p-6 rounded-xl shadow-lg h-min border-b-4 border-red-600">
                <h2 class="text-xl font-extrabold mb-4 border-b pb-2 text-gray-800 flex items-center">
                    <i class="fas fa-box-open text-red-600 mr-2"></i> Sipari≈ü √ñzeti
                </h2>
                
                <div id="cart-summary-list" class="space-y-4 border-b pb-4 mb-4">
                    </div>

                <div class="space-y-2 text-gray-700">
                    <div class="flex justify-between font-medium">
                        <span>Ara Toplam</span>
                        <span id="subtotal-display">0.00 TL</span>
                    </div>
                    <div class="flex justify-between text-sm text-green-600">
                        <span>ƒ∞ndirim</span>
                        <span id="discount-display">- 0.00 TL</span>
                    </div>
                    <div class="flex justify-between font-bold text-xl pt-3 border-t border-gray-200 text-gray-900">
                        <span>Genel Toplam</span>
                        <span id="total-display">0.00 TL</span>
                    </div>
                    <p id="total-usdt-info" class="text-md font-extrabold text-green-700 text-right mt-2 pt-2 border-t border-dashed border-green-200" style="display: none;"></p>
                </div>
                
                <button onclick="window.location.href='index.html'" class="w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 rounded-lg transition duration-200 text-sm">
                    <i class="fas fa-pencil-alt mr-2"></i> Sepeti D√ºzenle
                </button>

            </div>
        </div>
        
        <div class="lg:col-span-2 space-y-6">
            
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 pb-2 text-gray-800 flex items-center">
                    <span class="bg-red-600 text-white text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full mr-3">1</span>
                    E-posta Bilgisi
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label for="customer-email" class="block text-sm font-medium text-gray-700">E-posta Adresiniz *</label>
                        <input type="email" id="customer-email" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3" placeholder="mail@ornek.com">
                        <p class="text-xs text-gray-500 mt-1">Fatura, indirme linki ve t√ºm bilgiler bu adrese g√∂nderilecektir.</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-800 flex items-center">
                    <span class="bg-red-600 text-white text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full mr-3">2</span>
                    √ñdeme Y√∂ntemi Se√ßin
                </h2>
                
                <div class="mb-6">
                    <label for="payment-method-select" class="block text-sm font-medium text-gray-700 mb-2">Tercih Ettiƒüiniz √ñdeme Y√∂ntemi</label>
                    <select id="payment-method-select" onchange="updatePaymentDetails(this.value)" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 bg-white font-semibold cursor-pointer" value="EFT">
                        <option value="EFT">üè¶ EFT / Havale</option>
                        <option value="USDT">‚Çø Kripto (USDT TRC20)</option>
                        <option value="CREDIT">üí≥ Kart / Kredi Kartƒ±</option>
                    </select>
                </div>

                <div id="payment-details-content" class="space-y-6">
                    
                    <div id="payment-EFT" data-content>
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">Banka Bilgileri</h3>
                        <div class="space-y-3 p-4 bg-red-50 border border-red-200 rounded-lg">
                            <div class="flex justify-between items-center text-sm font-medium text-gray-700">
                                <span>Hesap Sahibi:</span>
                                <span id="bank-name-display" class="font-bold text-gray-900">REX Vƒ∞RTUAL STORE A.≈û.</span>
                            </div>
                            <div class="flex justify-between items-center text-sm font-medium text-gray-700">
                                <span>IBAN (Kopyala):</span>
                                <span id="bank-iban-display" class="font-bold text-red-600 cursor-pointer hover:underline" data-copy-text="TR550000111122223333444455" onclick="copyToClipboard('bank-iban-display')">
                                    TR55 0000 1111 2222 3333 4444 55
                                </span>
                            </div>
                            <p class="text-xs text-red-700 pt-2 border-t border-red-100">
                                <i class="fas fa-info-circle mr-1"></i> A√ßƒ±klama kƒ±smƒ±na SADECE e-posta adresinizi yazƒ±nƒ±z.
                            </p>
                        </div>
                    </div>
                    
                    <div id="payment-USDT" data-content style="display: none;">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">Kripto Para Bilgileri (TRC20 Aƒüƒ±)</h3>
                        <div class="space-y-3 p-4 bg-green-50 border border-green-200 rounded-lg">
                            <div class="flex justify-between items-center text-sm font-medium text-gray-700">
                                <span>G√∂nderilecek Miktar:</span>
                                <span id="usdt-amount-display" class="font-extrabold text-green-700 text-lg cursor-pointer hover:underline" data-copy-text="0.00" onclick="copyToClipboard('usdt-amount-display')">
                                    <i class="fas fa-spinner fa-spin mr-1"></i> Hesaplama...
                                </span>
                            </div>
                            
                            <div class="text-sm font-medium text-gray-700">
                                <span class="block mb-1">TRC20 C√ºzdan Adresi (Kopyala):</span>
                                <span id="usdt-address-display" 
                                    class="font-bold text-gray-900 cursor-pointer hover:underline block p-2 bg-white rounded break-all" 
                                    data-copy-text="TRC20_ADRESƒ∞_BURAYA_GELMELƒ∞_ORNEK_AƒûTRON"
                                    onclick="copyToClipboard('usdt-address-display')">
                                    TRC20_ADRESƒ∞_BURAYA_GELMELƒ∞_ORNEK_AƒûTRON
                                </span>
                            </div>
                            <p class="text-xs text-green-700 pt-2 border-t border-green-100">
                                <i class="fas fa-exclamation-triangle mr-1"></i> L√ºtfen yalnƒ±zca **USDT (TRC20 - TRON Aƒüƒ±)** g√∂nderin ve doƒüru aƒüƒ± se√ßtiƒüinizden emin olun!
                            </p>
                        </div>
                    </div>

                    <div id="payment-CREDIT" data-content style="display: none;">
                        <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg">
                            <h3 class="text-xl font-bold text-blue-700 mb-4 text-center">3D G√ºvenli Kart √ñdeme Ekranƒ±</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="card-number" class="block text-sm font-medium text-gray-700">Kart Numarasƒ± *</label>
                                    <input type="text" id="card-number" required pattern="\d{4}\s?\d{4}\s?\d{4}\s?\d{4}" maxlength="19" placeholder="XXXX XXXX XXXX XXXX" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3">
                                </div>
                                <div>
                                    <label for="card-holder" class="block text-sm font-medium text-gray-700">Kart √úzerindeki ƒ∞sim Soyisim *</label>
                                    <input type="text" id="card-holder" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3" placeholder="AD SOYAD">
                                </div>
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="col-span-2">
                                        <label for="card-expiry" class="block text-sm font-medium text-gray-700">Ge√ßerlilik Tarihi (Ay/Yƒ±l) *</label>
                                        <input type="text" id="card-expiry" required pattern="\d{2}/\d{2}" maxlength="5" placeholder="AA/YY" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3">
                                    </div>
                                    <div>
                                        <label for="card-cvv" class="block text-sm font-medium text-gray-700">CVV *</label>
                                        <input type="text" id="card-cvv" required pattern="\d{3,4}" maxlength="4" placeholder="XXX" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3">
                                    </div>
                                </div>
                            </div>
                            <p class="text-xs text-blue-700 mt-4 text-center">Bu bir sim√ºlasyon formudur. Ger√ßek √∂deme yapƒ±lmayacaktƒ±r.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-800 flex items-center">
                    <span class="bg-red-600 text-white text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full mr-3">3</span>
                    Sipari≈üi Onayla
                </h2>
                
                <form id="checkout-form" onsubmit="processOrder(event)">
                    <input type="hidden" id="selected-payment-method" value="EFT"> 
                    
                    <div id="receipt-upload-section">
                        <label for="receipt-file" class="block text-sm font-medium text-gray-700 mb-2">√ñdeme Dekontu Y√ºkle *</label>
                        <input type="file" id="receipt-file" required accept="image/*,application/pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
                        <p class="text-xs text-gray-500 mt-1">L√ºtfen √∂deme yaptƒ±ƒüƒ±nƒ±za dair dekontu y√ºkleyin (.jpg, .png veya .pdf)</p>
                    </div>

                    <div class="mt-6 flex items-start">
                        <input type="checkbox" id="terms-accepted" required class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500 mt-1">
                        <label for="terms-accepted" class="ml-3 text-sm font-medium text-gray-900">
                            <a href="#" class="text-red-600 hover:underline">≈ûartlar ve Ko≈üullarƒ±</a> okudum ve kabul ediyorum. *
                        </label>
                    </div>

                    <button type="submit" id="complete-order-btn" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-xl text-lg disabled:bg-red-400">
                        <i class="fas fa-check-circle mr-2"></i> √ñdemeyi Bildir ve √úr√ºn√º Al
                    </button>
                </form>
            </div>
            
        </div>
        
        <div class="lg:col-span-1 hidden lg:block">
            </div>

    </div>
</div>

<a id="support-button" href="https://t.me/rexvstoredestek" target="_blank" class="text-white p-4 rounded-full shadow-lg">
    <i class="fab fa-telegram-plane text-2xl"></i>
</a>


<script type="module">
    // üî• Firebase Mod√ºlleri
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, query, where, addDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js";
    
    // --- 1. GLOBAL DEƒûƒ∞≈ûKENLER VE AYARLAR ---
    let app, db, auth, storage;
    let productsData = []; 
    let cartItems = [];    
    let finalTotalTL = 0;
    
    // üöÄ G√úNCEL KUR: ƒ∞stenen 42 TL olarak ayarlandƒ±.
    const USDT_EXCHANGE_RATE = 42.0; 
    
    // üö®üö®üö® BURAYI KENDƒ∞ FIREBASE AYARLARINIZLA DOLDURUN üö®üö®üö® (Sizin verdiƒüiniz ayarlar)
    const firebaseConfig = {
        apiKey: "AIzaSyCR5mseCZP5tWLxzJHMewUTx3ipwIZgNoM", 
        authDomain: "rexvstore.firebaseapp.com",
        projectId: "rexvstore",
        storageBucket: "rexvstore.appspot.com", 
        messagingSenderId: "732705231158",
        appId: "1:732705231158:web:ba5ad9c627dcb8ea6ae397",
    };
    
    const APP_ID_PATH = 'rexvstore-main'; 
    const PUBLIC_DATA_ROOT = `artifacts/${APP_ID_PATH}/public/data`;
    const PRODUCTS_PATH = () => `${PUBLIC_DATA_ROOT}/products`; 
    const ORDERS_PATH = 'orders'; 

    // --- 2. FIREBASE BA≈ûLATMA & VERƒ∞ √áEKME ---
    async function initFirebase() {
        document.getElementById('loading-spinner').style.display = 'block';
        document.getElementById('checkout-content').style.display = 'none'; 
        document.getElementById('empty-cart').style.display = 'none';

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app); 
            
            await signInAnonymously(auth);
            
            const rawCart = localStorage.getItem('rexv_cart'); 
            cartItems = rawCart ? JSON.parse(rawCart) : [];
            
            if (cartItems.length === 0) {
                showEmptyCart();
                return;
            }

            const productIds = cartItems.map(item => item.id);
            if (productIds.length > 0) {
                const productsRef = collection(db, PRODUCTS_PATH());
                const q = query(productsRef, where("__name__", "in", productIds));
                const snapshot = await getDocs(q);
                
                productsData = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));
            }

            renderCartSummary(); 
            // Ba≈ülangƒ±√ßta EFT detaylarƒ±nƒ± ve butonu ayarla
            updatePaymentDetails('EFT');

        } catch (error) {
            console.error("üî• HATA: Veri Y√ºklenirken Hata Olu≈ütu:", error);
            Swal.fire('Hata', '√úr√ºn verileri y√ºklenirken bir sorun olu≈ütu. Konsolu kontrol edin. (Muhtemel Firebase Config hatasƒ±)', 'error');
            showEmptyCart(); 
        } finally {
            document.getElementById('loading-spinner').style.display = 'none';
        }
    }
    
    // --- 3. RENDER FONKSƒ∞YONLARI ---

    function showEmptyCart() {
        document.getElementById('empty-cart').style.display = 'block';
        document.getElementById('checkout-content').style.display = 'none';
    }

    function renderCartSummary() {
        const summaryDiv = document.getElementById('cart-summary-list');
        let subtotal = 0;
        let discount = 0;
        
        if (cartItems.length === 0) {
            showEmptyCart();
            return;
        }

        const summaryHtml = cartItems.map(cartItem => {
            const product = productsData.find(p => p.id === cartItem.id);
            if (!product) return ''; 

            const unitPrice = product.price || 0;
            const discountedPrice = product.discounted_price || unitPrice;
            const quantity = cartItem.qty || 1; 
            
            const totalItemPrice = discountedPrice * quantity; 
            const itemDiscount = (unitPrice - discountedPrice) * quantity;

            subtotal += unitPrice * quantity; 
            discount += itemDiscount;
            
            return `
                <div class="flex items-start justify-between">
                        <div class="flex-1 pr-4">
                        <p class="font-semibold text-gray-900">${product.name_tr || product.name}</p>
                        <p class="text-xs text-gray-500">${quantity} adet x ${discountedPrice.toLocaleString('tr-TR')} TL</p>
                    </div>
                    <span class="font-bold text-gray-800 flex-shrink-0">
                        ${totalItemPrice.toLocaleString('tr-TR')} TL
                    </span>
                </div>
            `;
        }).join('');

        finalTotalTL = subtotal - discount;
        
        // USDT Hesaplama (42 TL kuru ile)
        const finalTotalUSDT = (finalTotalTL / USDT_EXCHANGE_RATE).toFixed(2);

        summaryDiv.innerHTML = summaryHtml;
        document.getElementById('subtotal-display').textContent = subtotal.toLocaleString('tr-TR') + ' TL';
        document.getElementById('discount-display').textContent = '- ' + discount.toLocaleString('tr-TR') + ' TL';
        document.getElementById('total-display').textContent = finalTotalTL.toLocaleString('tr-TR') + ' TL';
        
        // USDT Bilgilerini G√ºncelle ve Kopyalama verisini ayarla
        document.getElementById('usdt-amount-display').textContent = `${finalTotalUSDT} USDT`;
        document.getElementById('usdt-amount-display').dataset.copyText = finalTotalUSDT; // Kopyalama i√ßin temiz deƒüer
        document.getElementById('total-usdt-info').innerHTML = `~ ${finalTotalUSDT} USDT (Kur: ${USDT_EXCHANGE_RATE.toFixed(1)} TL)`;

        document.getElementById('checkout-content').style.display = 'grid'; 
        document.getElementById('total-usdt-info').style.display = 'block';
    }

    // --- 4. √ñDEME Y√ñNTEMƒ∞ Y√ñNETƒ∞Mƒ∞ (SELECT MEN√ú ƒ∞LE) ---
    window.updatePaymentDetails = function(selectedMethod) {
        
        document.querySelectorAll('[data-content]').forEach(content => {
            content.style.display = 'none';
        });
        document.getElementById(`payment-${selectedMethod}`).style.display = 'block';
        
        document.getElementById('selected-payment-method').value = selectedMethod;
        
        const receiptSection = document.getElementById('receipt-upload-section');
        const receiptFile = document.getElementById('receipt-file');
        const completeOrderBtn = document.getElementById('complete-order-btn');

        // Kart bilgilerini zorunlu yap/kaldƒ±r
        const isCredit = selectedMethod === 'CREDIT';
        document.getElementById('card-number')?.toggleAttribute('required', isCredit);
        document.getElementById('card-holder')?.toggleAttribute('required', isCredit);
        document.getElementById('card-expiry')?.toggleAttribute('required', isCredit);
        document.getElementById('card-cvv')?.toggleAttribute('required', isCredit);


        if (isCredit) {
            receiptSection.style.display = 'none';
            receiptFile.removeAttribute('required');
            completeOrderBtn.innerHTML = '<i class="fas fa-credit-card mr-2"></i> Kart ile √ñdemeyi Tamamla';
        } else {
            receiptSection.style.display = 'block';
            receiptFile.setAttribute('required', 'required');
            completeOrderBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> √ñdemeyi Bildir ve √úr√ºn√º Al';
        }
    };
    
    // --- 5. KOPYALAMA ƒ∞≈ûLEMƒ∞ ---

    window.copyToClipboard = function(elementId) {
        const element = document.getElementById(elementId);
        const textToCopy = element.dataset.copyText || element.textContent.trim().replace(/\s/g, ''); 
        
        navigator.clipboard.writeText(textToCopy).then(() => {
            Swal.fire({
                icon: 'success',
                title: 'Kopyalandƒ±!',
                text: textToCopy,
                showConfirmButton: false,
                timer: 1000
            });
        }).catch(err => {
            console.error('Kopyalama hatasƒ±: ', err);
            Swal.fire('Hata', 'Kopyalama Ba≈üarƒ±sƒ±z.', 'error');
        });
    };

    // --- 6. Sƒ∞PARƒ∞≈û ƒ∞≈ûLEME FONKSƒ∞YONU ---

    window.processOrder = async function(event) {
        event.preventDefault();
        
        const paymentMethod = document.getElementById('selected-payment-method').value;
        const customerEmail = document.getElementById('customer-email').value;

        if (!customerEmail || !customerEmail.includes('@') || !customerEmail.includes('.')) {
            Swal.fire('Hata!', 'L√ºtfen ge√ßerli bir e-posta adresi girin.', 'error');
            return;
        }

        if (!document.getElementById('terms-accepted').checked) {
            Swal.fire('Hata!', 'Sipari≈üi tamamlamak i√ßin ≈ûartlar ve Ko≈üullarƒ± kabul etmelisiniz.', 'error');
            return;
        }

        const btn = document.getElementById('complete-order-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Sipari≈ü Olu≈üturuluyor...';
        
        try {
            let receiptURL = 'N/A'; 
            let status = 'Beklemede (√ñdeme Bildirildi)';
            
            // Kartla √∂deme sim√ºlasyonunda yapay gecikme
            if (paymentMethod === 'CREDIT') {
                await new Promise(r => setTimeout(r, 1500)); // 1.5 saniye bekleme
                status = 'Ba≈üarƒ±lƒ± (Kart Sim√ºlasyonu)'; 
                
            } else {
                const receiptFile = document.getElementById('receipt-file').files[0];
                if (!receiptFile) {
                    Swal.fire('Hata!', '√ñdemenizi tamamlamak i√ßin dekont y√ºklemelisiniz.', 'error');
                    // Hata olu≈ütuƒüunda butonu geri a√ß
                    btn.disabled = false;
                    updatePaymentDetails(paymentMethod);
                    return; 
                }
                
                // Dekont Y√ºkleme (EFT/USDT i√ßin)
                const receiptPath = `receipts/${auth.currentUser.uid}/${Date.now()}_${receiptFile.name}`;
                const storageRef = ref(storage, receiptPath);
                
                // Y√ºkleme sƒ±rasƒ±nda da butonu g√ºncelle
                btn.innerHTML = '<i class="fas fa-cloud-upload-alt mr-2"></i> Dekont Y√ºkleniyor...';
                
                const uploadResult = await uploadBytes(storageRef, receiptFile);
                receiptURL = await getDownloadURL(uploadResult.ref);
                status = 'Beklemede (Dekont Y√ºklendi)';
            }
            
            // Sipari≈ü Detaylarƒ±nƒ± Hazƒ±rlama
            const orderDetails = cartItems.map(item => {
                const product = productsData.find(p => p.id === item.id);
                return {
                    productId: item.id,
                    productName: product?.name_tr || product?.name || 'Bilinmeyen √úr√ºn',
                    quantity: item.qty || 1, 
                    finalPrice: product?.discounted_price || product?.price || 0,
                };
            });

            const orderData = {
                customer: {
                    email: customerEmail,
                    name: (paymentMethod === 'CREDIT' ? document.getElementById('card-holder').value : 'Kullanƒ±cƒ± Adƒ± Yok'), 
                    phone: 'Telefon Bilgisi Yok', 
                },
                items: orderDetails,
                totalTL: finalTotalTL,
                totalUSDT: (finalTotalTL / USDT_EXCHANGE_RATE).toFixed(2),
                paymentMethod: paymentMethod,
                receiptURL: receiptURL, 
                status: status, 
                createdAt: new Date(),
                userId: auth.currentUser ? auth.currentUser.uid : 'Anonim', 
            };
            
            // Firestore'a Sipari≈ü Ekleme
            btn.innerHTML = '<i class="fas fa-database mr-2"></i> Veritabanƒ±na Kaydediliyor...';
            const docRef = await addDoc(collection(db, ORDERS_PATH), orderData);

            localStorage.removeItem('rexv_cart');
            
            // Ba≈üarƒ± Bildirimi ve Y√∂nlendirme
            await Swal.fire({
                title: 'üéâ Sipari≈üiniz Ba≈üarƒ±yla Alƒ±ndƒ±!',
                html: `
                    <p class="text-base text-gray-700 mb-3">Sipari≈ü Numaranƒ±z: <b>#${docRef.id.substring(0, 8).toUpperCase()}</b></p>
                    <p class="text-sm text-gray-800 font-semibold mt-4 mb-2 flex items-center justify-center">
                        <i class="fas fa-envelope-open-text text-red-600 mr-2"></i> Bilgilendirme E-postanƒ±z G√∂nderildi
                    </p>
                    <p class="text-xs text-gray-600">Faturanƒ±z ve √ºr√ºn indirme/teslimat bilgileriniz en kƒ±sa s√ºrede <b>${customerEmail}</b> adresine g√∂nderilecektir. L√ºtfen spam klas√∂r√ºn√ºz√º kontrol etmeyi unutmayƒ±n!</p>
                `,
                icon: 'success',
                confirmButtonText: 'Ana Sayfaya D√∂n',
                allowOutsideClick: false,
                allowEscapeKey: false
            });

            // Y√∂nlendirme
            window.location.href = 'index.html'; 

        } catch (error) {
            console.error("üî• Sƒ∞PARƒ∞≈û OLU≈ûTURMA HATASI:", error);
            
            // Firebase Kurallarƒ± hatasƒ±nƒ± yakalayƒ±p kullanƒ±cƒ±ya √∂zel bir mesaj g√∂sterelim.
            let errorMessage = 'Sipari≈üiniz olu≈üturulamadƒ±. L√ºtfen tekrar deneyin.';
            if (error.code === 'permission-denied' || (error.message && error.message.includes('permission denied'))) {
                 errorMessage = `ƒ∞≈ülem Ba≈üarƒ±sƒ±z: Sunucu (Firebase) eri≈üim izni vermedi. L√ºtfen Firebase Firestore ve Storage G√ºvenlik Kurallarƒ±nƒ±zƒ± (Security Rules) kontrol edin. Anonim yazma izni gereklidir.`;
            } else if (error.code && error.code.includes('storage')) {
                errorMessage = `Dekont y√ºkleme ba≈üarƒ±sƒ±z. L√ºtfen dosya formatƒ±nƒ± (.jpg, .png, .pdf) veya Firebase Storage kurallarƒ±nƒ±zƒ± kontrol edin.`;
            }
            
            Swal.fire('Hata!', errorMessage + ' Detaylar i√ßin konsolu inceleyin.', 'error');
            
        } finally {
            // Hata olsun veya olmasƒ±n, butonu tekrar eski haline getir
            btn.disabled = false;
            updatePaymentDetails(paymentMethod);
        }
    }

    // Uygulama Ba≈ülatma
    window.onload = initFirebase;
    
</script>
</body>
</html>