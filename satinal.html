<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipari≈üi Tamamla - RexvStore</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .checkout-container { 
            max-width: 1100px; /* Biraz geni≈ületildi */
            flex-grow: 1;
        } 
        /* Kƒ±rmƒ±zƒ± odak rengi korundu */
        input:focus, textarea:focus, select:focus {
            border-color: #dc2626 !important;
            box-shadow: 0 0 0 1px rgba(220, 38, 38, 0.5) !important;
            outline: none;
        }
        #payment-method-select {
            appearance: none; 
            background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22none%22%3E%3Cpath%20d%3D%22M7%207l3%203%203-3m0%206l-3%203-3-3%22%20stroke%3D%22%23DC2626%22%22%20stroke-width%3D%221.5%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; 
        }
        #support-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            cursor: pointer;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            background-color: #1DA1F2; /* Telegram mavisi yerine daha belirgin bir mavi */
            box-shadow: 0 4px 15px rgba(29, 161, 242, 0.4);
        }
        #support-button:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(29, 161, 242, 0.6); 
        }
        .footer {
            background-color: #ffffff;
            border-top: 1px solid #e5e7eb;
            padding: 2rem 0;
            margin-top: 50px;
        }
    </style>
</head>
<body class="p-4 sm:p-6 pb-20"> 
    <div class="checkout-container mx-auto">
        <div class="flex items-center mb-8">
            <a href="index.html" class="text-red-600 hover:text-red-700 transition mr-4">
                <i class="fas fa-chevron-left text-xl"></i>
            </a>
            <h1 class="text-3xl font-bold text-gray-800">Sipari≈üi Tamamla</h1>
        </div>

        <div id="loading-spinner" class="text-center py-10" style="display: none;">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-red-500 border-t-transparent mx-auto mb-3"></div>
            <p class="text-gray-600 font-medium">Verileriniz ve sepet i√ßeriƒüiniz y√ºkleniyor...</p>
        </div>

        <div id="empty-cart" class="bg-white p-8 rounded-xl shadow-lg text-center" style="display: none;">
            <i class="fas fa-shopping-basket text-6xl text-gray-300 mb-4"></i>
            <h2 class="text-xl font-semibold mb-2">Sepetiniz Bo≈ü G√∂r√ºn√ºyor!</h2>
            <a href="index.html" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                √úr√ºnlere Geri D√∂n
            </a>
        </div>

        <div id="checkout-content" class="lg:grid lg:grid-cols-3 lg:gap-8" style="display: none;">
            
            <div class="lg:col-span-2 space-y-6 order-2 lg:order-1">
                
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 pb-2 text-gray-800 flex items-center">
                        <span class="bg-red-600 text-white text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full mr-3">1</span>
                        ƒ∞leti≈üim ve Not Bilgileri
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="customer-email" class="block text-sm font-medium text-gray-700">E-posta Adresiniz *</label>
                            <input type="email" id="customer-email" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3" placeholder="mail@ornek.com">
                            <p class="text-xs text-gray-500 mt-1">Fatura, indirme linki ve t√ºm bilgiler bu adrese g√∂nderilecektir.</p>
                        </div>
                        
                        <div>
                            <label for="order-note" class="block text-sm font-medium text-gray-700">Sipari≈ü Notu (ƒ∞steƒüe Baƒülƒ±)</label>
                            <textarea id="order-note" rows="3" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3" placeholder="√ñzel bir istek veya ek bilgi varsa buraya yazabilirsiniz."></textarea>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-800 flex items-center">
                        <span class="bg-red-600 text-white text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full mr-3">2</span>
                        √ñdeme Y√∂ntemi Se√ßin
                    </h2>
                    
                    <div class="mb-6">
                        <label for="payment-method-select" class="block text-sm font-medium text-gray-700 mb-2">Tercih Ettiƒüiniz √ñdeme Y√∂ntemi</label>
                        <select id="payment-method-select" onchange="updatePaymentDetails(this.value)" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 bg-white font-semibold cursor-pointer" value="EFT">
                            <option value="EFT">üè¶ EFT / Havale</option>
                            <option value="USDT">‚Çø Kripto (USDT TRC20)</option>
                            <option value="CREDIT">üí≥ Kart / Kredi Kartƒ±</option>
                        </select>
                    </div>

                    <div id="payment-details-content" class="space-y-6">
                        
                        <div id="payment-EFT" data-content>
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">Banka Bilgileri</h3>
                            <div class="space-y-3 p-4 bg-red-50 border border-red-200 rounded-lg">
                                <div class="flex justify-between items-center text-sm font-medium text-gray-700">
                                    <span>Hesap Sahibi:</span>
                                    <span id="bank-name-display" class="font-bold text-gray-900">VELAT YA≈ûAR</span>
                                </div>
                                <div class="flex justify-between items-center text-sm font-medium text-gray-700">
                                    <span>IBAN (Kopyala):</span>
                                    <span id="bank-iban-display" class="font-bold text-red-600 cursor-pointer hover:underline" data-copy-text="TR590020600221044335590001" onclick="copyToClipboard('bank-iban-display')">
                                        TR59 0020 6002 2104 4335 5900 01
                                    </span>
                                </div>
                                <p class="text-xs text-red-700 pt-2 border-t border-red-100">
                                    <i class="fas fa-info-circle mr-1"></i> A√ßƒ±klama kƒ±smƒ±na SADECE **e-posta adresinizi veya cep telefonunuzu** yazƒ±nƒ±z.
                                </p>
                            </div>
                        </div>
                        
                        <div id="payment-USDT" data-content style="display: none;">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">Kripto Para Bilgileri (TRC20 Aƒüƒ±)</h3>
                            <div class="space-y-3 p-4 bg-green-50 border border-green-200 rounded-lg">
                                <div class="flex justify-between items-center text-sm font-medium text-gray-700">
                                    <span>G√∂nderilecek Miktar:</span>
                                    <span id="usdt-amount-display" class="font-extrabold text-green-700 text-lg cursor-pointer hover:underline" data-copy-text="0.00" onclick="copyToClipboard('usdt-amount-display')">
                                        <i class="fas fa-spinner fa-spin mr-1"></i> Hesaplama...
                                    </span>
                                </div>
                                
                                <div class="text-sm font-medium text-gray-700">
                                    <span class="block mb-1">TRC20 C√ºzdan Adresi (Kopyala):</span>
                                    <span id="usdt-address-display" 
                                        class="font-bold text-gray-900 cursor-pointer hover:underline block p-2 bg-white rounded break-all" 
                                        data-copy-text="TPHNV2S6d5oFJarPVju2XV2xBkwDbbyjaH"
                                        onclick="copyToClipboard('usdt-address-display')">
                                        TPHNV2S6d5oFJarPVju2XV2xBkwDbbyjaH
                                    </span>
                                </div>
                                <p class="text-xs text-green-700 pt-2 border-t border-green-100">
                                    <i class="fas fa-exclamation-triangle mr-1"></i> L√ºtfen yalnƒ±zca **USDT (TRC20 - TRON Aƒüƒ±)** g√∂nderin ve doƒüru aƒüƒ± se√ßtiƒüinizden emin olun!
                                </p>
                            </div>
                        </div>

                        <div id="payment-CREDIT" data-content style="display: none;">
                            <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg">
                                <h3 class="text-xl font-bold text-blue-700 mb-4 text-center">G√ºvenli Kart √ñdeme Sistemi</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="card-number" class="block text-sm font-medium text-gray-700">Kart Numarasƒ± *</label>
                                        <input type="text" id="card-number" required pattern="\d{4}\s?\d{4}\s?\d{4}\s?\d{4}" maxlength="19" placeholder="XXXX XXXX XXXX XXXX" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3">
                                    </div>
                                    <div>
                                        <label for="card-holder" class="block text-sm font-medium text-gray-700">Kart √úzerindeki ƒ∞sim Soyisim *</label>
                                        <input type="text" id="card-holder" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3" placeholder="AD SOYAD">
                                    </div>
                                    <div class="grid grid-cols-3 gap-4">
                                        <div class="col-span-2">
                                            <label for="card-expiry" class="block text-sm font-medium text-gray-700">Ge√ßerlilik Tarihi (Ay/Yƒ±l) *</label>
                                            <input type="text" id="card-expiry" required pattern="\d{2}/\d{2}" maxlength="5" placeholder="AA/YY" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3">
                                        </div>
                                        <div>
                                            <label for="card-cvv" class="block text-sm font-medium text-gray-700">CVV *</label>
                                            <input type="text" id="card-cvv" required pattern="\d{3,4}" maxlength="4" placeholder="XXX" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3">
                                        </div>
                                    </div>
                                </div>
                                <p class="text-xs text-blue-700 mt-4 text-center font-semibold">
                                    <i class="fas fa-lock mr-1"></i> Bu kƒ±sƒ±m **3D Secure** ile korunmaktadƒ±r. √ñdeme sim√ºlasyonu ba≈üarƒ±lƒ± olursa sipari≈üiniz alƒ±nacaktƒ±r.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-800 flex items-center">
                        <span class="bg-red-600 text-white text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full mr-3">3</span>
                        Sipari≈üi Onayla
                    </h2>
                    
                    <form id="checkout-form" onsubmit="processOrder(event)">
                        <input type="hidden" id="selected-payment-method" value="EFT"> 
                        
                        <div id="receipt-upload-section">
                            <label for="receipt-file" class="block text-sm font-medium text-gray-700 mb-2">√ñdeme Dekontu Y√ºkle *</label>
                            <input type="file" id="receipt-file" required accept="image/*,application/pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
                            <p class="text-xs text-red-500 mt-1 font-semibold">NOT: EFT/USDT √∂demelerinde dekont se√ßilmesi **zorunludur**.</p>
                        </div>
                        <div class="mt-6 flex items-start">
                            <input type="checkbox" id="terms-accepted" required class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500 mt-1">
                            <label for="terms-accepted" class="ml-3 text-sm font-medium text-gray-900">
                                <a href="sartlar_ve_kosullar.html" target="_blank" class="text-red-600 hover:underline font-bold">≈ûartlar ve Ko≈üullarƒ±</a> okudum ve kabul ediyorum. *
                            </label>
                        </div>

                        <button type="submit" id="complete-order-btn" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-xl text-lg disabled:bg-red-400">
                            <i class="fas fa-check-circle mr-2"></i> √ñdemeyi Bildir ve √úr√ºn√º Al
                        </button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-shield-alt text-red-600 mr-2"></i> Neden Bize G√ºvenmelisiniz?
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div>
                            <i class="fas fa-truck-loading text-2xl text-green-600 mb-1"></i>
                            <p class="text-xs font-semibold">Anƒ±nda Teslimat</p>
                        </div>
                        <div>
                            <i class="fas fa-lock text-2xl text-blue-600 mb-1"></i>
                            <p class="text-xs font-semibold">3D G√ºvenli √ñdeme</p>
                        </div>
                        <div>
                            <i class="fas fa-headset text-2xl text-red-600 mb-1"></i>
                            <p class="text-xs font-semibold">7/24 Canlƒ± Destek</p>
                        </div>
                        <div>
                            <i class="fas fa-medal text-2xl text-yellow-600 mb-1"></i>
                            <p class="text-xs font-semibold">Memnuniyet Garantisi</p>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold text-gray-800 mt-6 mb-4 flex items-center border-t pt-4">
                        <i class="fas fa-credit-card text-red-600 mr-2"></i> Kabul Edilen √ñdeme Y√∂ntemleri
                    </h3>
                    <div class="flex flex-wrap justify-center space-x-4">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/4/4b/Visa_2014_logo_detail.svg" alt="Visa" class="h-6 opacity-70">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/a/ac/Mastercard_2019_logo.svg" alt="Mastercard" class="h-6 opacity-70">
                        <i class="fab fa-cc-paypal text-3xl text-blue-800 opacity-70"></i>
                        <i class="fab fa-bitcoin text-3xl text-orange-400 opacity-70"></i>
                        <i class="fas fa-university text-3xl text-gray-600 opacity-70"></i>
                    </div>
                </div>

                <div class="mt-8 text-sm text-gray-600 space-y-3 p-4 border border-gray-200 bg-white rounded-xl shadow-sm">
                    <h3 class="font-bold text-red-600">√ñnemli Bilgilendirme</h3>
                    <p><i class="fas fa-undo-alt mr-2"></i> **ƒ∞ade Politikasƒ±:** Dijital √ºr√ºnlerde teslimat ger√ßekle≈ütikten sonra iade **m√ºmk√ºn deƒüildir**. L√ºtfen sipari≈üinizi kontrol ediniz.</p>
                    <p><i class="fas fa-file-contract mr-2"></i> **Kullanƒ±m Ko≈üullarƒ±:** √ñdeme yapƒ±ldƒ±ktan sonra t√ºm sorumluluk m√º≈üteriye aittir. √úr√ºn teslimatƒ± e-posta ile anƒ±nda yapƒ±lacaktƒ±r. Sorunlar i√ßin destek hattƒ±mƒ±z aktiftir.</p>
                </div>
                
            </div>
            
            <div class="lg:col-span-1 mb-6 order-1 lg:order-2">
                <div class="bg-white p-6 rounded-xl shadow-lg h-min border-l-4 border-red-600 lg:sticky lg:top-8">
                    <h2 class="text-xl font-extrabold mb-4 border-b pb-2 text-gray-800 flex items-center">
                        <i class="fas fa-shopping-cart text-red-600 mr-2"></i> Sepetiniz
                    </h2>
                    
                    <div id="cart-summary-list" class="space-y-4 border-b pb-4 mb-4 max-h-60 overflow-y-auto">
                        </div>

                    <div class="space-y-2 text-gray-700">
                        <div class="flex justify-between font-medium">
                            <span>Ara Toplam</span>
                            <span id="subtotal-display">0.00 TL</span>
                        </div>
                        <div class="flex justify-between text-sm text-green-600">
                            <span>ƒ∞ndirim</span>
                            <span id="discount-display">- 0.00 TL</span>
                        </div>
                        <div class="flex justify-between font-bold text-xl pt-3 border-t border-gray-200 text-gray-900">
                            <span>Genel Toplam</span>
                            <span id="total-display">0.00 TL</span>
                        </div>
                        <p id="total-usdt-info" class="text-md font-extrabold text-green-700 text-right mt-2 pt-2 border-t border-dashed border-green-200" style="display: none;"></p>
                    </div>
                    
                    <button onclick="window.location.href='index.html'" class="w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 rounded-lg transition duration-200 text-sm">
                        <i class="fas fa-pencil-alt mr-2"></i> Sepeti D√ºzenle
                    </button>

                </div>
            </div>
            
            <div class="lg:col-span-3">
                </div>

        </div>
    </div>

    <footer class="footer">
        <div class="checkout-container mx-auto px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between items-center text-sm text-gray-500">
            <div class="mb-3 sm:mb-0">
                &copy; 2024 RexvStore. T√ºm Haklarƒ± Saklƒ±dƒ±r.
            </div>
            <div class="space-x-4">
                <a href="gizlilik_politikasi.html" target="_blank" class="hover:text-red-600 transition">Gizlilik Politikasƒ±</a>
                <a href="sartlar_ve_kosullar.html" target="_blank" class="hover:text-red-600 transition">≈ûartlar ve Ko≈üullar</a>
                <a href="hakkimizda.html" target="_blank" class="hover:text-red-600 transition">Hakkƒ±mƒ±zda</a>
            </div>
        </div>
    </footer>
    
    <a id="support-button" href="https://t.me/rexfinans" target="_blank" class="text-white p-4 rounded-full shadow-lg">
        <i class="fab fa-telegram-plane text-2xl"></i>
    </a>


<script type="module">
    // üî• Firebase Mod√ºlleri
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, addDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    
    // --- 1. GLOBAL DEƒûƒ∞≈ûKENLER VE AYARLAR ---
    let app, db, auth; 
    let productsData = []; 
    let cartItems = [];    
    let finalTotalTL = 0;
    
    // USDT kuru: Burayƒ± gerektiƒüinde g√ºncelleyin.
    const USDT_EXCHANGE_RATE = 42.0; 
    
    // üö®üö®üö® BURAYI KENDƒ∞ FIREBASE AYARLARINIZLA DOLDURUN üö®üö®üö®
    const firebaseConfig = {
        apiKey: "AIzaSyCR5mseCZP5tWLxzJHMewUTx3ipwIZgNoM", 
        authDomain: "rexvstore.firebaseapp.com",
        projectId: "rexvstore",
        storageBucket: "rexvstore.appspot.com", 
        messagingSenderId: "732705231158",
        appId: "1:732705231158:web:ba5ad9c627dcb8ea6ae397",
    };
    
    const APP_ID_PATH = 'rexvstore-main'; 
    const PUBLIC_DATA_ROOT = `artifacts/${APP_ID_PATH}/public/data`;
    const PRODUCTS_PATH = () => `${PUBLIC_DATA_ROOT}/products`; 
    const ORDERS_PATH = 'orders'; 

    // Yardƒ±mcƒ± Fonksiyon: Diziyi 10'luk par√ßalara ayƒ±rƒ±r (Firestore limitasyonu i√ßin)
    function chunkArray(array, chunkSize) {
        const chunks = [];
        for (let i = 0; i < array.length; i += chunkSize) {
            chunks.push(array.slice(i, i + chunkSize));
        }
        return chunks;
    }
    
    // --- 2. FIREBASE BA≈ûLATMA & VERƒ∞ √áEKME ---
    
    // Asƒ±l veri √ßekme ve render etme i≈ülemini yapan fonksiyon
    async function fetchAndRenderData() {
        try {
            const rawCart = localStorage.getItem('rexv_cart'); 
            cartItems = rawCart ? JSON.parse(rawCart) : [];
            
            if (cartItems.length === 0) {
                showEmptyCart();
                return;
            }

            const productIds = cartItems.map(item => item.id);
            productsData = []; 

            if (productIds.length > 0) {
                const productsRef = collection(db, PRODUCTS_PATH());
                
                // Firestore IN sorgusunun 10 ID limitini a≈ümak i√ßin par√ßalara ayƒ±rma
                const idChunks = chunkArray(productIds, 10);
                
                const queryPromises = idChunks.map(chunk => {
                    const q = query(productsRef, where("__name__", "in", chunk)); 
                    return getDocs(q);
                });
                
                const results = await Promise.all(queryPromises);
                
                // T√ºm sonu√ßlarƒ± tek bir dizide birle≈ütir
                results.forEach(snapshot => {
                    snapshot.docs.forEach(doc => {
                        productsData.push({ id: doc.id, ...doc.data() });
                    });
                });
            }

            if (productsData.length === 0 && cartItems.length > 0) {
                 // Veri √ßekilemediyse (g√ºvenlik kuralƒ± hatasƒ± veya yanlƒ±≈ü yol)
                 throw new Error("Sepetteki √ºr√ºnlerin verileri √ßekilemedi. G√ºvenlik kurallarƒ±nƒ± veya veritabanƒ± yolunu kontrol edin.");
            }

            renderCartSummary(); 
            updatePaymentDetails('EFT'); 
            document.getElementById('checkout-content').style.display = 'grid'; 

        } catch (error) {
            console.error("üî• HATA: Veri Y√ºklenirken Hata Olu≈ütu:", error);
            
            let errorMessage = 'Sepet i√ßeriƒüi y√ºklenirken kritik bir sorun olu≈ütu.';
            
            if (error.code === 'permission-denied' || error.message.includes('permission-denied')) {
                 errorMessage = 'KRƒ∞Tƒ∞K HATA: Firebase Firestore G√ºvenlik Kurallarƒ±nƒ±z, √ºr√ºnleri okumanƒ±za izin vermiyor. L√ºtfen kurallarƒ± kontrol edin.';
            }

            Swal.fire('Hata', errorMessage, 'error');
            showEmptyCart(); 
        } finally {
            document.getElementById('loading-spinner').style.display = 'none';
        }
    }

    async function initFirebase() {
        document.getElementById('loading-spinner').style.display = 'block';
        document.getElementById('checkout-content').style.display = 'none'; 

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // onAuthStateChanged, kullanƒ±cƒ±nƒ±n oturum durumunu bekler
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Kullanƒ±cƒ± Giri≈ü yapmƒ±≈ü, verileri √ßek
                    await fetchAndRenderData();
                } else {
                    // Kullanƒ±cƒ± Giri≈ü yapmamƒ±≈üsa, index.html'e y√∂nlendir
                    console.warn("Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü. Y√∂nlendiriliyor...");
                    Swal.fire({
                        icon: 'warning',
                        title: 'Giri≈ü Gerekli',
                        text: 'Sipari≈üi tamamlamak i√ßin √∂nce giri≈ü yapmalƒ±sƒ±nƒ±z.',
                        confirmButtonText: 'Giri≈ü Yap',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    }).then(() => {
                        window.location.href = 'index.html'; 
                    });
                }
            });

        } catch (error) {
            console.error("üî• HATA: Firebase Ba≈ülatƒ±lamadƒ±:", error);
            Swal.fire('Hata', 'Firebase baƒülantƒ±sƒ± kurulamadƒ±. Ayarlarƒ±nƒ±zƒ± kontrol edin.', 'error');
            document.getElementById('loading-spinner').style.display = 'none';
        }
    }
    
    // --- 3. RENDER FONKSƒ∞YONLARI ---

    function showEmptyCart() {
        document.getElementById('empty-cart').style.display = 'block';
        document.getElementById('checkout-content').style.display = 'none';
        document.getElementById('loading-spinner').style.display = 'none';
    }
    
    function renderCartSummary() {
        const summaryDiv = document.getElementById('cart-summary-list');
        let subtotal = 0;
        let discount = 0;
        
        if (cartItems.length === 0) {
            showEmptyCart();
            return;
        }

        const summaryHtml = cartItems.map(cartItem => {
            const product = productsData.find(p => p.id === cartItem.id);
            if (!product) {
                console.warn(`√úr√ºn verisi bulunamadƒ±: ${cartItem.id}. Bu √ºr√ºn √∂zet listesine eklenmiyor.`);
                return ``; 
            } 

            const unitPrice = product.price || 0;
            const discountedPrice = product.discounted_price || unitPrice;
            const quantity = cartItem.qty || 1; 
            
            const totalItemPrice = discountedPrice * quantity; 
            const itemDiscount = (unitPrice - discountedPrice) * quantity;

            subtotal += unitPrice * quantity; 
            discount += itemDiscount;
            
            return `
                <div class="flex items-start justify-between">
                    <div class="flex-1 pr-4">
                        <p class="font-semibold text-gray-900">${product.name_tr || product.name}</p>
                        <p class="text-xs text-gray-500">${quantity} adet x ${discountedPrice.toLocaleString('tr-TR')} TL</p>
                    </div>
                    <span class="font-bold text-gray-800 flex-shrink-0">
                        ${totalItemPrice.toLocaleString('tr-TR')} TL
                    </span>
                </div>
            `;
        }).join('');

        finalTotalTL = subtotal - discount;
        
        // USDT hesaplamasƒ±
        const finalTotalUSDT = (finalTotalTL / USDT_EXCHANGE_RATE).toFixed(2);

        summaryDiv.innerHTML = summaryHtml;
        document.getElementById('subtotal-display').textContent = subtotal.toLocaleString('tr-TR') + ' TL';
        document.getElementById('discount-display').textContent = '- ' + discount.toLocaleString('tr-TR') + ' TL';
        document.getElementById('total-display').textContent = finalTotalTL.toLocaleString('tr-TR') + ' TL';
        
        // USDT kopyalanabilir miktarƒ± g√ºncellendi
        document.getElementById('usdt-amount-display').textContent = `${finalTotalUSDT} USDT`;
        document.getElementById('usdt-amount-display').dataset.copyText = finalTotalUSDT; 
        document.getElementById('total-usdt-info').innerHTML = `~ ${finalTotalUSDT} USDT (Kur: ${USDT_EXCHANGE_RATE.toFixed(1)} TL)`;

        document.getElementById('checkout-content').style.display = 'grid'; 
        document.getElementById('total-usdt-info').style.display = 'block';
    }


    // --- 4. √ñDEME Y√ñNTEMƒ∞ Y√ñNETƒ∞Mƒ∞ ---
    window.updatePaymentDetails = function(selectedMethod) {
        
        document.querySelectorAll('[data-content]').forEach(content => {
            content.style.display = 'none';
        });
        document.getElementById(`payment-${selectedMethod}`).style.display = 'block';
        
        document.getElementById('selected-payment-method').value = selectedMethod;
        
        const receiptSection = document.getElementById('receipt-upload-section');
        const receiptFile = document.getElementById('receipt-file');
        const completeOrderBtn = document.getElementById('complete-order-btn');

        const isCredit = selectedMethod === 'CREDIT';
        
        // Kart alanlarƒ±nƒ±n zorunluluƒüunu ayarla
        document.getElementById('card-number')?.toggleAttribute('required', isCredit);
        document.getElementById('card-holder')?.toggleAttribute('required', isCredit);
        document.getElementById('card-expiry')?.toggleAttribute('required', isCredit);
        document.getElementById('card-cvv')?.toggleAttribute('required', isCredit);


        if (isCredit) {
            // Kart ile √∂deme se√ßildiƒüinde dekont y√ºkleme kaldƒ±rƒ±lƒ±r
            receiptSection.style.display = 'none';
            receiptFile.removeAttribute('required');
            completeOrderBtn.innerHTML = '<i class="fas fa-credit-card mr-2"></i> Kart ile √ñdemeyi Tamamla';
        } else {
            // EFT/USDT se√ßildiƒüinde dekont y√ºkleme zorunlu
            receiptSection.style.display = 'block';
            receiptFile.setAttribute('required', 'required');
            completeOrderBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> √ñdemeyi Bildir ve √úr√ºn√º Al';
        }
    };
    
    // --- 5. KOPYALAMA ƒ∞≈ûLEMƒ∞ ---

    window.copyToClipboard = function(elementId) {
        const element = document.getElementById(elementId);
        // data-copy-text varsa onu kullan, yoksa i√ßeriƒüi temizleyip kullan.
        const textToCopy = element.dataset.copyText || element.textContent.trim().replace(/\s/g, ''); 
        
        navigator.clipboard.writeText(textToCopy).then(() => {
            Swal.fire({
                icon: 'success',
                title: 'Kopyalandƒ±!',
                text: textToCopy,
                showConfirmButton: false,
                timer: 1000
            });
        }).catch(err => {
            console.error('Kopyalama hatasƒ±: ', err);
            Swal.fire('Hata', 'Kopyalama Ba≈üarƒ±sƒ±z.', 'error');
        });
    };

    // --- 6. Sƒ∞PARƒ∞≈û ƒ∞≈ûLEME FONKSƒ∞YONU ---

    window.processOrder = async function(event) {
        event.preventDefault();
        
        const paymentMethod = document.getElementById('selected-payment-method').value;
        const customerEmail = document.getElementById('customer-email').value;
        const orderNote = document.getElementById('order-note').value; // YENƒ∞: Sipari≈ü Notu

        if (!customerEmail || !customerEmail.includes('@') || !customerEmail.includes('.')) {
            Swal.fire('Hata!', 'L√ºtfen ge√ßerli bir e-posta adresi girin.', 'error');
            return;
        }

        if (!document.getElementById('terms-accepted').checked) {
            Swal.fire('Hata!', 'Sipari≈üi tamamlamak i√ßin ≈ûartlar ve Ko≈üullarƒ± kabul etmelisiniz.', 'error');
            return;
        }

        if (!auth.currentUser) {
            Swal.fire('Hata!', 'Sipari≈üi tamamlamak i√ßin giri≈ü yapmanƒ±z gerekiyor.', 'error');
            return;
        }
        
        const btn = document.getElementById('complete-order-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Sipari≈ü Olu≈üturuluyor...';
        
        try {
            let receiptURL = 'N/A'; 
            let status = 'Beklemede (√ñdeme Bildirildi)';
            
            if (paymentMethod === 'CREDIT') {
                // Kart bilgileri sadece sim√ºlasyon ama√ßlƒ± kontrol edilir, sunucuya g√∂nderilmez.
                if (!document.getElementById('card-number').value || !document.getElementById('card-holder').value) {
                     Swal.fire('Hata!', 'L√ºtfen kart bilgilerinizi eksiksiz doldurun.', 'error');
                     btn.disabled = false;
                     updatePaymentDetails(paymentMethod);
                     return;
                }
                
                await new Promise(r => setTimeout(r, 1500)); 
                status = 'Ba≈üarƒ±lƒ± (Kart Sim√ºlasyonu)'; 
                
            } else {
                const receiptFile = document.getElementById('receipt-file').files[0];
                if (!receiptFile) {
                    Swal.fire('Hata!', '√ñdemenizi tamamlamak i√ßin dekont se√ßmelisiniz.', 'error');
                    btn.disabled = false;
                    updatePaymentDetails(paymentMethod);
                    return; 
                }
                
                btn.innerHTML = '<i class="fas fa-check-double mr-2"></i> Dekont Se√ßildi. Kaydediliyor...';
                receiptURL = `Y√ºklendi (Dosya Adƒ±: ${receiptFile.name})`;
                status = 'Beklemede (Dekont Se√ßimi Onaylandƒ±)';
            }
            
            // Sipari≈ü Detaylarƒ±nƒ± Hazƒ±rlama
            const orderDetails = cartItems.map(item => {
                const product = productsData.find(p => p.id === item.id);
                
                return {
                    productId: item.id,
                    productName: product?.name_tr || product?.name || 'Bilinmeyen √úr√ºn',
                    quantity: item.qty || 1, 
                    finalPrice: product?.discounted_price || product?.price || 0, 
                };
            });

            const orderData = {
                customer: {
                    email: customerEmail,
                    name: (paymentMethod === 'CREDIT' ? document.getElementById('card-holder').value : auth.currentUser.email || 'Kullanƒ±cƒ± Adƒ± Yok'), 
                    phone: 'Telefon Bilgisi Yok', 
                    note: orderNote, // YENƒ∞: Sipari≈ü notu eklendi
                },
                items: orderDetails,
                totalTL: finalTotalTL,
                totalUSDT: (finalTotalTL / USDT_EXCHANGE_RATE).toFixed(2),
                paymentMethod: paymentMethod,
                receiptURL: receiptURL,
                status: status, 
                createdAt: new Date(),
                userId: auth.currentUser.uid, 
            };
            
            // Firestore'a Sipari≈ü Ekleme
            btn.innerHTML = '<i class="fas fa-database mr-2"></i> Veritabanƒ±na Kaydediliyor...';
            const docRef = await addDoc(collection(db, ORDERS_PATH), orderData);

            // Sepeti Temizleme
            localStorage.removeItem('rexv_cart');
            
            await Swal.fire({
                title: 'üéâ Sipari≈üiniz Ba≈üarƒ±yla Alƒ±ndƒ±!',
                html: `<p class="text-base text-gray-700 mb-3">Sipari≈ü Numaranƒ±z: <b>#${docRef.id.substring(0, 8).toUpperCase()}</b></p><p class="text-sm text-gray-600">Sipari≈ü detaylarƒ±nƒ±z e-posta adresinize g√∂nderilmi≈ütir. √ñdeme kontrol√º sonrasƒ± √ºr√ºn√ºn√ºz teslim edilecektir.</p>`,
                icon: 'success',
                confirmButtonText: 'Sipari≈ülerime Git',
                allowOutsideClick: false,
                allowEscapeKey: false
            });

            window.location.href = 'siparislerim.html'; 

        } catch (error) {
            console.error("üî• Sƒ∞PARƒ∞≈û OLU≈ûTURMA HATASI:", error);
            
            let errorMessage = 'Sipari≈üiniz olu≈üturulamadƒ±. L√ºtfen sunucu baƒülantƒ±nƒ±zƒ± veya Firebase kurallarƒ±nƒ± kontrol edin.';
            
            if (error.code === 'permission-denied' || error.message.includes('permission-denied')) {
                 errorMessage = 'VERƒ∞TABANI YAZMA HATASI: Firebase Firestore G√ºvenlik Kurallarƒ±nƒ±z, **orders** koleksiyonuna yazmamƒ±za izin vermiyor olabilir.';
            }

            Swal.fire('Hata!', errorMessage + ' Detaylar i√ßin konsolu inceleyin.', 'error');
            
        } finally {
            btn.disabled = false;
            updatePaymentDetails(paymentMethod);
        }
    }

    // Uygulama Ba≈ülatma
    window.onload = initFirebase;
    
</script>
</body>
</html>